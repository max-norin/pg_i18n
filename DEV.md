# Особенности

- расширение является помощником в создании i18n представления,
  в дальнейшем при использовании базы данных можно править готовый код представлений и триггеров
  для получения желаемых результатов - оптимизатор написания i18n представления
- при желании, чтобы триггер не удалялся после удаления представления - нужно удалить из него защитный комментарий

# Заметки

1. `DEFAULT` используется внутри запроса только для полей primary keys - для сохранения вычислений последовательностей.
   В иных случаях использовать `DEFAULT` нет возможности, так как нельзя выяснить внутри триггерной функции или внутри правила
   какая колонка имела значение `DEFAULT` в изначальном запросе.
   Использование `IS DISTINCT FROM` ни к чему не привело.
   Через `GET DIAGNOSTICS stack = PG_CONTEXT;` и переменные `TG_*` нет возможности получить изначальный запрос,
   чтобы так же можно было использовать `DEFAULT`
2. не обновлять `NEW` после первой вставки - так как будет разное поведение при `INSERT` и `UPSERT`.
   например, поле `title` одноимённое в обеих таблицах (`untrans` и `trans`),
   во время операции `INSERT` колонка `title` была изменена, то в итоге пользователю вернется не тот результат, который он ожидал;
   но при этом ещё раз отправив такой результат пользователь получит ожидаемый ответ.
3. не изменять в триггерах значения в одноимённых колонках, либо изменять на одинаковые значения.
   это касается UI. например, пользователь решил сохранить данные и сохранение в первую таблицу (`untrans`) изменило эти данные,
   например, колонку `title`, тогда в строках представления (`i18n`) относящихся к первой таблице (`untrans`)
   и не имеющих соответствующих записей с языками во второй таблице (`trans`) будет иметь неизвестно откуда взявшееся значение.
   пользователь будет в замешательстве
4. если действие `UPDATE`, но при этом нет записи во второй таблице (`trans`), то нужно делать `INSERT` во вторую таблицу
5. если действие `UPDATE` и таблицы (`untrans` и `trans`) имеют одноимённые колонки, то обновлять (`UPSERT`)
   одноименную колонку только в `trans` - не обновлять `NEW`
6. если действие `INSERT` и таблицы (`untrans` и `trans`) имеют одноимённые колонки,
   то если это значение уже есть в первой таблице (`untrans`),
   то обновить только разноимённые колонки в первой таблице (`untrans`) - не обновлять `NEW`
   если записи в первой таблице нет, то вставить её туда и потом вставить во вторую таблицу (`trans`) - не обновлять `NEW`
7. если есть запись в первой таблице (`untrans`), то в представлении (`i18n`) будут записи по всем существующим языкам таблицы (`langs`),
   так как идёт перекрёстное объединение. расширение придёрживается концепции, что представление имеет такие же законы, как таблица
   поэтому вставку можно делать только не существующих в первой таблице (`trans`) записей.
   поэтому обновление доступно для всех записей представления (`i18n`) включая записи отсутствующие во второй таблице (`untrans`)
8. возвращаемый результат в отдельную переменную, чтобы в случае изменения функции в любом месте функции
   была возможность обратиться к изначальному `NEW`, результату первого запроса (`base_new`) и результату второго запроса (`tran_new`).
9. возвращаемый результат рассчитывать в функции, а не использовать
   `SELECT * INTO NEW FROM v_words WHERE (id, lang) = (NEW.id, NEW.lang)`
   так как это затратный оператор, нежели использовать готовые данные.
   использовать `base_new || tran_new`.
10. обновлять `primary keys` после вставки данных в первую таблицу, чтобы вторая правильно ссылалась
11. нельзя обновлять `lang`, так как в представление (`i18n`) после операции `INSERT` существуют записи по всем языкам, а так как
    `lang` является `primary keys`, то нельзя обновить `lang` с таким же `primary keys`,
    так как такая запись уже существует в представлении (`i18n`)
12. нельзя обновлять `primary keys` вместе с `lang`, так как эта операция является нелогичной,
    потому что обновляемая запись имеет перевод на языке `lang` и смена `primary keys` не должна влиять на значения перевода
13. `primary keys` первой таблицы (`untrans`) доступен для обновления, но только в одной строке представления (`i18n`)
14. при обновлении если не указан `lang`, то будет вставка и обновление во вторую таблицу для всех языков (`untrans`)
15. при удалении расширения `DROP EXTENSION "pg_i18n" CASCADE;` удаляется представление (`i18n`),
    но остаются default представление (`i18n_default`) и тригернные функции `__insert` `__update`,
    так как в представлении (`i18n_default`) не участвуют элементы расширения
    (в `i18n` используется таблица `lang`, поэтому оно удаляется),
    тригернные функции `__insert` `__update` удаляются только благодаря `EVENT_TRIGGER` и не имеют связи с расширением
    (`EVENT_TRIGGER` удаляется совместно с `i18n` поэтому его действия не применяются)

# TODO

- [x] обозначить важные моменты при вставке и обновлении представления
- [x] определить как обновлять данные одинаковых колонок если запись в таблице 1 и 2 уже есть
- [x] продумать что будет если вставить в представление запись, которая есть в первой таблице.
  что будет если вставить запись, которая есть во второй таблице. с условием, что идёт перекрёстное соединение с `langs`
- [x] попробовать запустить старую версию и посмотреть какие там моменты я делал - иначе сделано - не смотрел
- [x] удалить `ON CONFLICT pk` для вставки в `untran` таблицу - 7 заметка
- [x] сделать два триггера для удобства просмотра и редактирования, при желании изменить триггер
- [x] проверить как видно код `rule` `trigger` в IDE - оба выглядят круто
- [x] написать `UPSET` запрос в `trigger` обновления
- [x] найти откуда пробел в запросе `(  id)` - непонятно откуда берутся
- [x] сделать вывод запросов в консоль перед исполнением - вывел в режиме `debug`
- [x] добавить обновление pk после вставки в первую таблицу
- [x] оптимизировать `jsonb_populate_record` - уже оптимизированною
- [x] сделать два варианта: через правила и через триггеры - через правила получается нагружено
  и скорее невозможно повторить такой же эффект, как у триггера
- [x] прописать +/- использовать правила и триггеры - нет необходимости писать
- [x] добавить туда, где используется функция `array_to_string` функцию `array_format`
- [x] обнулить `result`
- [x] обновить `EVENT_TRIGGER` по именам
- [x] добавить в `EVENT_TRIGGER` проверку, что это триггеры написанный расширением, проверить наличие защитного комментария
- [x] обновить `get_i18n_view_name`
- [x] попробовать вместо `jsonb_populate_record` использовать `record || record`
- [x] продумать использовать `SELECT * INTO NEW FROM i18n` или `record || record` - `SELECT` это энергетически затратная операция
- [x] обновлять primary keys после вставки данных в первую таблицу
- [x] запретить обновлять `lang`, но разрешить обновлять `primary keys`
- [ ] обновить `dist`
- [ ] обновить документацию
    - [ ] написать как по другому можно установить
    - [ ] обновить текст по архитектуре
    - [ ] добавить список запросов, которые будут выполнены при запуске функции
    - [ ] добавить картинку как выглядит база данных после создания представления
    - [ ] добавить про особенности этого расширения
    - [x] удалить рекомендации
    - [ ] изменить старое именование таблиц на новое
    - [ ] указать файл тестирования в репозитории для визуализации работы
    - [ ] написать про изменения в версии: oid -> regclass, rename
- [ ] при изменении колонок в таблице, связанной с i18n представлениями, нужно пересоздавать представления
- [ ] описать и добавить операцию `DELETE`

# Проверки

- [ ] протестировать на больших данные и нагрузке запросами
- [x] проверить вставку в таблицу `langs`
- [x] проверить корректность колонок `is_tran`, `is_default_lang` в представлении `i18n`
- [x] проверить корректность одноименных колонок (`title`) в представлении `i18n`
- [x] написать файл с тестированием таблицами i18n_words и i18n_product
    - [x] `INSERT` вставить языки в таблицу `langs` (ok)
    - [x] `CREATE` создать представление `i18n` (ok)
    - [x] `CREATE` создать представление `i18n` с пустыми `relid` (error)
    - [x] `INSERT` вставить `id=1&lang=ru` (ok), `id=1&lang=ru` (error), `id=1&lang=en` (error), `id=default&lang=en` (ok)
    - [x] `INSERT` только в таблицу `untans` - посмотреть, как вставилось в представление (`i18n`) (ok)
    - [x] `UPDATE` обновить запись, где `id=-1`, при этом такого `id` не должно существовать (ok)
    - [x] `UPDATE` обновить запись, где `id=1` - должны обновиться все переводы (ok)
    - [x] `UPDATE` обновить запись, где `id=1`, но только колонки первой таблицы (`untrans`) - должны обновиться все переводы (ok)
    - [x] `UPDATE` обновить `id=1&lang=ru`, где `id=1&lang=en` - смена языка не поддерживается (error)
    - [x] `UPDATE` обновить `id=-1&lang=ru`, где `id=1&lang=en` - смена языка не поддерживается (error)
    - [x] `UPDATE` обновить `id=-1&lang=ru`, где `id=1&lang=ru` - смена `primary keys` (ok)
    - [x] `UPDATE` обновить `id=-1`, где `id=1` и существуют все переводы - смена `primary keys` (error)
    - [x] `UPDATE` обновить запись, где `id=1&lang=ru`, при этом во второй таблице (`trans`) должна быть эта запись (ok)
    - [x] `UPDATE` обновить запись, где `id=1&lang=en`, при этом во второй таблице (`trans`) не должно быть этой записи (ok)
    - [x] `UPDATE` обновить одноименную колонку таблиц `untrans` и `trans` (ok)
    - [x] `UPDATE` обновить колонку принадлежащую только `untrans` (ok)
    - [x] `UPDATE` обновить колонку принадлежащую только `trans` (ok)
    - [x] `UPDATE` обновить не редактируемые колонки `is_tran`, `is_default_lang`
    - [x] `DROP` удалить `i18n` (ok), `i18n_defualt` (ok), `i18n__insert` (error), `i18n__update` (error)
    - [x] `DROP` удалить `trans` (ok), `untrans` (ok), `i18n__insert` (error), `i18n__update` (error)
- [x] проверить работу `EVENT_TRIGGER`
    - [x] изучить последствия действия `DROP EXTENSION "pg_i18n" CASCADE;`
